{% extends 'layout.html' %}
{% block title %}后台管理{% endblock %}
{% block content %}
<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="card-title mb-0">后台管理</h3>
            <a href="{{ url_for('main.logout') }}" class="btn btn-sm btn-secondary">退出登录</a>
        </div>

        <!-- 导航标签 -->
        <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tokens-tab" data-bs-toggle="tab" data-bs-target="#tokens" type="button" role="tab">
                    Token 管理
                </button>
            </li>
            {% if config.get('LINUXDO_OAUTH_ENABLED', false) %}
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                    Linux.do 用户管理
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="{{ url_for('main.admin_requests') }}">剧集申请管理</a>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cleanup-tab" data-bs-toggle="tab" data-bs-target="#cleanup" type="button" role="tab">
                    用户清理管理
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" href="{{ url_for('main.admin_deletion_logs') }}">删除记录查看</a>
            </li>
            {% endif %}
        </ul>

        <!-- Token 管理标签页 -->
        <div class="tab-content" id="adminTabContent">
            <div class="tab-pane fade show active" id="tokens" role="tabpanel">

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row mb-4">
            <div class="col-md-6">
                <form method="post" action="{{ url_for('main.generate_token') }}" class="d-grid">
                    <button type="submit" class="btn btn-success">生成新 Token</button>
                </form>
            </div>
            <div class="col-md-6">
                <a href="{{ url_for('main.export_unused_tokens') }}" class="btn btn-info d-grid">
                    <i class="fas fa-download"></i> 导出未用Token
                </a>
            </div>
        </div>
        
        <form method="get" action="{{ url_for('main.admin') }}" class="row g-2 mb-4">
            <div class="col-md-9">
                <input type="text" name="q" class="form-control" placeholder="搜索 Token 或用户名" value="{{ search_query }}">
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-outline-primary w-100">搜索</button>
            </div>
        </form>
        
        <h5 class="mt-4">有效 Token 列表
            {% if public_access_url == 'YOUR_DOMAIN.com' %}
                <small class="text-danger">(请设置 PUBLIC_ACCESS_URL 环境变量以修正域名)</small>
            {% endif %}
        </h5>
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th scope="col" style="width: 80%;">注册链接</th>
                        <th scope="col">状态</th>
                        <th scope="col" style="width: 6ch; white-space: nowrap;">注册用户</th>
                        <th scope="col" style="width: 1%; white-space: nowrap;">*操作*</th>
                    </tr>
                </thead>
                <tbody>
                    {% for token in tokens %}
                    <tr>
                        <td style="word-break: break-all;">
                            {{ public_access_url }}/emby?token={{ token.full_signed_token }}
                        </td>
                        <td>
                            {% if token.is_used %}
                                <span class="badge bg-success">已用</span>
                            {% else %}
                                <span class="badge bg-primary">未用</span>
                            {% endif %}
                        </td>
                        <td style="width: 6ch; word-break: break-all;">
                            {% if token.username %}
                                {{ token.username }}
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex flex-column gap-2">
                                <button class="btn btn-sm btn-outline-info" 
                                        onclick="copyTextToClipboard('{{ public_access_url }}/emby?token={{ token.full_signed_token }}', this)">
                                    复制
                                </button>
                                
                                <form class="mb-0" method="post" action="{{ url_for('main.delete_token', token_id=token.id) }}" onsubmit="return confirm('确定要删除这个Token吗？');">
                                    <button type="submit" class="btn btn-sm btn-danger">删除</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center">没有可用的 Token。</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# --- NEW: Render the pagination controls --- #}
        <div class="d-flex justify-content-center mt-4">
            {{ pagination.links }}
        </div>
            </div>

            <!-- Linux.do 用户管理标签页 -->
            {% if config.get('LINUXDO_OAUTH_ENABLED', false) %}
            <div class="tab-pane fade" id="users" role="tabpanel">
                <h5 class="mb-3">Linux.do 用户列表</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead>
                            <tr>
                                <th scope="col">用户名</th>
                                <th scope="col">昵称</th>
                                <th scope="col">信任等级</th>
                                <th scope="col">邮箱</th>
                                <th scope="col">注册数量</th>
                                <th scope="col">最后登录</th>
                                <th scope="col">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in linuxdo_users %}
                            <tr>
                                <td>{{ user.username }}</td>
                                <td>{{ user.name }}</td>
                                <td>
                                    <span class="badge bg-{{ 'success' if user.trust_level >= 3 else 'warning' if user.trust_level >= 1 else 'secondary' }}">
                                        {{ user.trust_level }}级
                                    </span>
                                </td>
                                <td>{{ user.email or '—' }}</td>
                                <td>
                                    <span class="badge bg-info">{{ user.registration_count }}/{{ user.max_allowed }}</span>
                                </td>
                                <td>{{ user.last_login }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" onclick="viewUserRegistrations('{{ user.id }}')">
                                        查看注册记录
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center">暂无 Linux.do 用户。</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 用户清理管理标签页 -->
            <div class="tab-pane fade" id="cleanup" role="tabpanel">
                <h5 class="mb-3">用户清理管理</h5>
                
                <!-- 清理功能状态 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">清理功能状态</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <strong>功能状态:</strong>
                                    {% if cleanup_config.enabled %}
                                        <span class="badge bg-success">已启用</span>
                                    {% else %}
                                        <span class="badge bg-danger">已禁用</span>
                                    {% endif %}
                                </div>
                                <div class="mb-2">
                                    <strong>调度器状态:</strong>
                                    {% if scheduler_status.running %}
                                        <span class="badge bg-success">运行中</span>
                                    {% else %}
                                        <span class="badge bg-danger">已停止</span>
                                    {% endif %}
                                </div>
                                <div class="mb-2">
                                    <strong>新用户清理天数:</strong> {{ cleanup_config.new_user_days }} 天
                                </div>
                                <div class="mb-2">
                                    <strong>不活跃用户清理天数:</strong> {{ cleanup_config.inactive_user_days }} 天
                                </div>
                                <div class="mb-2">
                                    <strong>检查间隔:</strong> {{ cleanup_config.interval_hours }} 小时
                                </div>
                                <div class="mb-2">
                                    <strong>安全限制:</strong>
                                    {% if cleanup_config.only_platform_users %}
                                        <span class="badge bg-success">仅删除平台用户</span>
                                    {% else %}
                                        <span class="badge bg-warning">删除所有用户</span>
                                    {% endif %}
                                </div>
                                <div class="mb-2">
                                    <strong>孤儿记录清理:</strong>
                                    {% if cleanup_config.cleanup_orphaned %}
                                        <span class="badge bg-info">已启用</span>
                                    {% else %}
                                        <span class="badge bg-secondary">已禁用</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">定时任务信息</h6>
                            </div>
                            <div class="card-body">
                                {% if scheduler_status.jobs %}
                                    {% for job in scheduler_status.jobs %}
                                    <div class="mb-2">
                                        <strong>任务名称:</strong> {{ job.name }}<br>
                                        <strong>下次执行:</strong> 
                                        {% if job.next_run_time %}
                                            <span class="next-run-time" data-utc-time="{{ job.next_run_time }}">
                                                {{ job.next_run_time }}
                                            </span>
                                        {% else %}
                                            <span class="text-muted">未计划</span>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">暂无定时任务</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 手动操作区域 -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">手动操作</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <strong>注意:</strong> 手动清理将立即检查所有用户并删除符合条件的不活跃用户。此操作不可逆，请谨慎使用。
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <h6>完整清理</h6>
                                <p class="text-muted small">执行不活跃用户清理 + 孤儿记录清理</p>
                                <form method="post" action="{{ url_for('main.admin_cleanup_users') }}" 
                                      onsubmit="return confirm('确定要立即执行完整用户清理吗？此操作将删除符合条件的不活跃用户和孤儿记录，操作不可逆！');">
                                    <button type="submit" class="btn btn-warning w-100" 
                                            {% if not cleanup_config.enabled %}disabled{% endif %}>
                                        <i class="fas fa-broom"></i> 立即执行完整清理
                                    </button>
                                </form>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <h6>孤儿记录清理</h6>
                                <p class="text-muted small">仅清理Emby中不存在的注册记录</p>
                                <form method="post" action="{{ url_for('main.admin_cleanup_orphaned') }}" 
                                      onsubmit="return confirm('确定要执行孤儿记录清理吗？此操作将删除Emby中不存在的注册记录。');">
                                    <button type="submit" class="btn btn-info w-100" 
                                            {% if not cleanup_config.cleanup_orphaned %}disabled{% endif %}>
                                        <i class="fas fa-search"></i> 清理孤儿记录
                                    </button>
                                </form>
                            </div>
                        </div>
                        
                        {% if not cleanup_config.enabled %}
                        <small class="text-muted">用户清理功能已禁用，无法执行完整清理</small>
                        {% endif %}
                        
                        {% if not cleanup_config.cleanup_orphaned %}
                        <small class="text-muted">孤儿记录清理功能已禁用</small>
                        {% endif %}
                    </div>
                </div>
                
                <!-- 清理规则说明 -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">清理规则说明</h6>
                    </div>
                    <div class="card-body">
                        <ul class="mb-0">
                            <li><strong>新注册用户:</strong> 注册超过 {{ cleanup_config.new_user_days }} 天且从未登录过的用户将被删除</li>
                            <li><strong>不活跃用户:</strong> 最近 {{ cleanup_config.inactive_user_days }} 天内未登录的用户将被删除</li>
                            <li><strong>孤儿记录清理:</strong> 
                                {% if cleanup_config.cleanup_orphaned %}
                                    <span class="text-info">自动检测并清理Emby服务器中不存在的注册记录</span>
                                {% else %}
                                    <span class="text-muted">孤儿记录清理已禁用</span>
                                {% endif %}
                            </li>
                            <li><strong>自动执行:</strong> 系统每 {{ cleanup_config.interval_hours }} 小时自动检查一次</li>
                            <li><strong>安全限制:</strong> 
                                {% if cleanup_config.only_platform_users %}
                                    <span class="text-success">仅删除通过平台注册的用户，管理员手动创建的用户不会被删除</span>
                                {% else %}
                                    <span class="text-warning">会删除所有符合条件的用户（包括管理员创建的）</span>
                                {% endif %}
                            </li>
                            <li><strong>删除范围:</strong> 删除用户时会同时删除Emby中的用户账号和数据库中的注册历史记录</li>
                        </ul>
                    </div>
                </div>
                
                <!-- 环境变量配置说明 -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">配置说明</h6>
                    </div>
                    <div class="card-body">
                        <p>可通过以下环境变量调整清理功能:</p>
                        <ul class="mb-0">
                            <li><code>ENABLE_USER_CLEANUP</code>: 是否启用用户清理功能 (true/false, 默认: true)</li>
                            <li><code>CLEANUP_NEW_USER_DAYS</code>: 新用户未登录清理天数 (默认: 7)</li>
                            <li><code>CLEANUP_INACTIVE_USER_DAYS</code>: 用户不活跃清理天数 (默认: 30)</li>
                            <li><code>CLEANUP_INTERVAL_HOURS</code>: 清理检查间隔小时数 (默认: 24)</li>
                            <li><code>CLEANUP_ONLY_PLATFORM_USERS</code>: 仅删除平台创建的用户 (true/false, 默认: true) <span class="badge bg-info">安全</span></li>
                            <li><code>CLEANUP_ORPHANED_RECORDS</code>: 清理孤儿记录 (true/false, 默认: true) <span class="badge bg-success">推荐</span></li>
                        </ul>
                    </div>
                </div>
                
                <!-- 最近删除记录 -->
                {% if recent_deletions %}
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">最近删除记录</h6>
                        <div>
                            <span class="badge bg-info">总计: {{ total_deletions }} 条</span>
                            <a href="{{ url_for('main.admin_deletion_logs') }}" class="btn btn-sm btn-outline-primary ms-2">查看全部</a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>用户名</th>
                                        <th>删除原因</th>
                                        <th>删除时间</th>
                                        <th>方式</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for log in recent_deletions %}
                                    <tr>
                                        <td>
                                            <strong>{{ log.emby_username }}</strong>
                                            {% if log.linuxdo_username %}
                                            <br><small class="text-muted">@{{ log.linuxdo_username }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-danger small">{{ log.deletion_reason }}</span>
                                        </td>
                                        <td>
                                            <small class="deletion-time" data-utc-time="{{ log.deleted_at.isoformat() if log.deleted_at else '' }}">
                                                {{ log.deleted_at.strftime('%m-%d %H:%M') if log.deleted_at.strftime else log.deleted_at }}
                                            </small>
                                        </td>
                                        <td>
                                            {% if log.deleted_by == 'system_cleanup' %}
                                                <span class="badge bg-primary small">自动</span>
                                            {% else %}
                                                <span class="badge bg-secondary small">{{ log.deleted_by }}</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 用户注册记录模态框 -->
<div class="modal fade" id="userRegModal" tabindex="-1" aria-labelledby="userRegModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userRegModalLabel">注册记录</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <div class="modal-body">
        <div id="userRegTable"></div>
      </div>
    </div>
  </div>
</div>

<script>
function copyTextToClipboard(textToCopy, buttonElement) {
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(textToCopy).then(() => {
            showCopyFeedback(buttonElement, true);
        }).catch(err => {
            console.error('Modern copy failed: ', err);
            showCopyFeedback(buttonElement, false);
        });
    } else {
        const textArea = document.createElement("textarea");
        textArea.value = textToCopy;
        textArea.style.position = "fixed";
        textArea.style.top = "-9999px";
        textArea.style.left = "-9999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            showCopyFeedback(buttonElement, successful);
        } catch (err) {
            console.error('Fallback copy failed: ', err);
            showCopyFeedback(buttonElement, false);
        }
        document.body.removeChild(textArea);
    }
}

function showCopyFeedback(buttonElement, isSuccess) {
    const originalText = buttonElement.innerHTML;
    if (isSuccess) {
        buttonElement.innerHTML = '复制';
        buttonElement.classList.remove('btn-outline-info');
        buttonElement.classList.add('btn-success');
    } else {
        buttonElement.innerHTML = '失败';
        buttonElement.classList.remove('btn-outline-info');
        buttonElement.classList.add('btn-danger');
    }
    setTimeout(() => {
        buttonElement.innerHTML = originalText;
        if (isSuccess) {
            buttonElement.classList.remove('btn-success');
        } else {
            buttonElement.classList.remove('btn-danger');
        }
        buttonElement.classList.add('btn-outline-info');
    }, 2000);
}

function viewUserRegistrations(userId) {
    fetch("{{ url_for('main.admin_user_registrations') }}?user_id=" + encodeURIComponent(userId))
    .then(r => r.json())
    .then(data => {
        if (!data.success) {
            alert('加载失败：' + data.msg);
            return;
        }
        let html = '<table class="table table-striped"><thead><tr><th>用户名</th><th>初始密码</th><th>注册时间</th></tr></thead><tbody>';
        if (data.data.length === 0) {
            html += '<tr><td colspan="3" class="text-center">暂无注册记录</td></tr>';
        } else {
            for (const reg of data.data) {
                html += `<tr>
                    <td>${reg.emby_username}</td>
                    <td>${reg.emby_password || '-'}</td>
                    <td>${reg.registered_at}</td>
                </tr>`;
            }
        }
        html += '</tbody></table>';
        document.getElementById('userRegTable').innerHTML = html;
        var modal = new bootstrap.Modal(document.getElementById('userRegModal'));
        modal.show();
    })
    .catch(e => {
        alert('请求失败');
    });
}

// 时区转换功能
function convertToLocalTime() {
    // 获取所有需要转换时区的元素
    const timeElements = document.querySelectorAll('.next-run-time, .deletion-time');
    
    timeElements.forEach(element => {
        const utcTimeStr = element.getAttribute('data-utc-time');
        if (!utcTimeStr) return;
        
        try {
            // 解析UTC时间
            const utcDate = new Date(utcTimeStr);
            
            // 检查是否为有效日期
            if (isNaN(utcDate.getTime())) {
                console.warn('无效的时间格式:', utcTimeStr);
                return;
            }
            
            // 转换为本地时间并格式化
            const localTimeStr = formatLocalDateTime(utcDate);
            
            // 根据元素类型决定显示格式
            if (element.classList.contains('next-run-time')) {
                // 定时任务时间：显示完整格式
                element.innerHTML = `
                    <span class="text-success">${localTimeStr}</span>
                    <br><small class="text-muted">本地时间 (UTC${getTimezoneOffset()})</small>
                `;
            } else if (element.classList.contains('deletion-time')) {
                // 删除时间：简化格式
                const shortFormat = formatShortDateTime(utcDate);
                element.innerHTML = shortFormat;
                element.setAttribute('title', `本地时间 (UTC${getTimezoneOffset()})\n完整时间: ${localTimeStr}`);
            }
            
        } catch (error) {
            console.error('时间转换失败:', error, '原始时间:', utcTimeStr);
        }
    });
}

// 格式化本地日期时间
function formatLocalDateTime(date) {
    const options = {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    };
    
    return date.toLocaleString('zh-CN', options);
}

// 格式化短时间格式（用于表格显示）
function formatShortDateTime(date) {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
    
    // 判断是否为今天
    if (dateOnly.getTime() === today.getTime()) {
        // 今天：只显示时间
        return date.toLocaleString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
    } else {
        // 其他日期：显示月-日 时:分
        return date.toLocaleString('zh-CN', {
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
    }
}

// 获取时区偏移显示
function getTimezoneOffset() {
    const offset = -(new Date().getTimezoneOffset());
    const hours = Math.floor(Math.abs(offset) / 60);
    const minutes = Math.abs(offset) % 60;
    const sign = offset >= 0 ? '+' : '-';
    
    return `${sign}${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
}

// 页面加载完成后执行时区转换
document.addEventListener('DOMContentLoaded', function() {
    // 延迟执行以确保所有元素都已渲染
    setTimeout(convertToLocalTime, 100);
});
</script>
{% endblock %}
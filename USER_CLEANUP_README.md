# Emby用户清理功能说明

## 功能概述

本功能为Emby注册服务添加了自动用户清理功能，可以自动删除不活跃的用户，帮助维护服务器的整洁性和资源利用率。

## 主要特性

- ✅ **自动清理**: 根据配置的规则自动清理不活跃用户
- ✅ **灵活配置**: 通过环境变量灵活配置清理规则
- ✅ **定时执行**: 支持定时自动执行和手动触发
- ✅ **完整删除**: 同时删除Emby服务器用户和数据库注册记录
- ✅ **管理界面**: 提供Web管理界面监控和控制清理功能
- ✅ **详细日志**: 记录详细的清理过程和结果

## 清理规则

### 新注册用户清理
- **条件**: 注册超过指定天数且从未登录过
- **默认**: 7天
- **环境变量**: `CLEANUP_NEW_USER_DAYS`

### 不活跃用户清理
- **条件**: 最近指定天数内未登录
- **默认**: 30天  
- **环境变量**: `CLEANUP_INACTIVE_USER_DAYS`

### 执行频率
- **默认**: 每24小时检查一次
- **环境变量**: `CLEANUP_INTERVAL_HOURS`

### 孤儿记录清理
- **条件**: 数据库中存在但Emby服务器中不存在的用户记录
- **用途**: 处理手动删除、同步问题等导致的数据不一致
- **环境变量**: `CLEANUP_ORPHANED_RECORDS`

## 环境变量配置

| 变量名 | 描述 | 默认值 | 示例 |
|--------|------|--------|------|
| `ENABLE_USER_CLEANUP` | 是否启用用户清理功能 | `true` | `true/false` |
| `CLEANUP_NEW_USER_DAYS` | 新用户未登录清理天数 | `7` | `7` |
| `CLEANUP_INACTIVE_USER_DAYS` | 用户不活跃清理天数 | `30` | `30` |
| `CLEANUP_INTERVAL_HOURS` | 清理检查间隔（小时） | `24` | `24` |
| `CLEANUP_ONLY_PLATFORM_USERS` | 仅删除平台创建的用户 | `true` | `true/false` |
| `CLEANUP_ORPHANED_RECORDS` | 清理孤儿记录 | `true` | `true/false` |

### 配置示例

```bash
# .env 文件
ENABLE_USER_CLEANUP=true
CLEANUP_NEW_USER_DAYS=7
CLEANUP_INACTIVE_USER_DAYS=30
CLEANUP_INTERVAL_HOURS=12
CLEANUP_ONLY_PLATFORM_USERS=true  # 安全限制：仅删除平台创建的用户
CLEANUP_ORPHANED_RECORDS=true     # 清理孤儿记录：删除Emby中不存在的注册记录
```

## 使用说明

### 1. 启用功能

确保在环境变量中设置：
```bash
ENABLE_USER_CLEANUP=true
```

### 2. 配置清理规则

根据需要调整清理规则：
```bash
# 新用户5天未登录就清理
CLEANUP_NEW_USER_DAYS=5

# 用户45天不活跃就清理  
CLEANUP_INACTIVE_USER_DAYS=45

# 每12小时检查一次
CLEANUP_INTERVAL_HOURS=12
```

### 3. 启动应用

正常启动Flask应用，定时任务会自动开始：
```bash
python app.py
```

### 4. 管理界面

通过Web管理界面可以：
- 查看清理功能状态
- 查看定时任务信息
- 手动触发清理操作
- 查看配置参数

访问路径：`/admin` → "用户清理管理" 标签页

### 5. 手动执行清理

除了自动定时执行，还可以通过管理界面手动触发清理：
1. 登录管理后台
2. 切换到"用户清理管理"标签页
3. 点击"立即执行用户清理"按钮

## API接口

### 获取清理状态
```
GET /admin/cleanup_status
```

返回清理功能状态和配置信息。

### 手动执行清理
```
POST /admin/cleanup_users
```

立即执行一次用户清理操作。

## 日志记录

系统会记录详细的清理日志，包括：
- 清理任务开始和结束时间
- 检查的用户数量
- 删除的用户数量和详细信息
- 错误信息和异常处理

查看日志示例：
```
INFO: 开始清理不活跃用户，检查 15 个用户
INFO: 清理规则: 新用户 7 天未登录，老用户 30 天未活跃
INFO: 准备删除不活跃用户: test_user_1 - 注册超过7天(10天)且从未登录
INFO: 成功删除不活跃用户: test_user_1
INFO: 用户清理完成: 检查了 15 个用户，删除了 1 个用户
```

## 孤儿记录清理功能

### 功能概述
孤儿记录清理是一个数据一致性维护功能，用于检测和清理数据库中存在但Emby服务器中已不存在的用户记录。

### 应用场景
- **管理员手动删除**: 管理员在Emby中直接删除用户，但数据库记录仍然存在
- **数据同步问题**: 由于网络错误、服务重启等导致的数据不一致
- **外部删除**: 通过其他工具或API删除了Emby用户
- **数据恢复**: Emby数据库恢复后某些用户丢失

### 工作原理
1. **获取Emby用户列表**: 通过Emby API获取服务器中的所有用户
2. **对比数据库记录**: 检查数据库中的每个注册记录
3. **识别孤儿记录**: 标记Emby中不存在的用户记录
4. **安全清理**: 删除孤儿记录并记录到删除日志
5. **释放配额**: 清理后用户可以重新注册

### 清理流程
```
数据库记录: [user1, user2, user3, user4]
Emby用户:   [user1, user3, user4]
检测结果:    user2 是孤儿记录
执行清理:    删除 user2 的注册记录
结果:       释放该用户的注册配额
```

### 日志记录
孤儿记录清理会详细记录：
- 被清理的用户信息
- 删除原因："孤儿记录清理：用户在Emby服务器中不存在"
- 删除方式："system_orphan_cleanup"
- 注册历史等信息

### 手动执行
除了自动执行，管理员可以在管理后台手动触发：
- 登录管理后台
- 进入"用户清理管理"标签页
- 点击"清理孤儿记录"按钮

## 安全限制功能

### 平台用户验证
为了确保安全，系统默认启用了严格的用户验证机制，**只删除通过平台注册的用户**。

#### 验证机制
1. **数据库记录验证**: 检查用户是否在 `user_registrations` 表中有记录
2. **用户信息匹配**: 验证Emby中的用户名与数据库记录是否一致  
3. **模板策略检查**: 可选验证用户策略是否来自配置的模板用户
4. **多重安全检查**: 多层验证确保只删除平台创建的用户

#### 被保护的用户
以下用户**不会被删除**：
- ✅ 管理员手动在Emby中创建的用户
- ✅ 通过其他方式创建的用户
- ✅ 数据库记录不匹配的用户
- ✅ 验证失败的用户

#### 配置选项
```bash
# 启用平台用户验证（强烈推荐）
CLEANUP_ONLY_PLATFORM_USERS=true

# 禁用验证（不推荐，仅用于特殊情况）
CLEANUP_ONLY_PLATFORM_USERS=false
```

## 安全注意事项

⚠️ **重要提醒**:
- 用户清理操作是**不可逆**的
- **默认只删除平台创建的用户**，管理员创建的用户受到保护
- 建议保持 `CLEANUP_ONLY_PLATFORM_USERS=true` 以确保安全
- 建议在生产环境使用前先在测试环境验证
- 确保备份重要数据
- 定期检查清理日志确保功能正常

## 故障排除

### 1. 清理功能未启动
- 检查 `ENABLE_USER_CLEANUP` 是否设置为 `true`
- 查看应用启动日志是否有错误信息
- 确认必要的环境变量已正确设置

### 2. 无法删除用户
- 检查 `EMBY_API_KEY` 是否有足够权限
- 确认 Emby 服务器连接正常
- 查看错误日志了解具体失败原因

### 3. 定时任务不执行
- 检查调度器状态
- 确认应用不是在调试模式的副进程中运行
- 查看调度器相关日志

## 测试

可以使用提供的测试脚本验证功能：
```bash
python test_cleanup.py
```

测试脚本会：
- 验证配置功能
- 测试清理逻辑（模拟环境）
- 显示使用说明

## 用户删除记录

### 功能概述
系统会自动记录所有被删除用户的详细信息，用于审计、分析和故障排查。

### 记录内容
每条删除记录包含以下信息：
- **用户信息**: Emby用户ID、用户名、关联的Linux.do用户
- **删除原因**: 详细的删除原因说明
- **时间信息**: 注册时间、最后活跃时间、删除时间
- **统计数据**: 注册天数、未活跃天数
- **操作记录**: 删除方式（自动清理/管理员操作）

### 查看方式

#### 1. 管理后台查看
- 登录管理后台
- 点击"删除记录查看"标签
- 支持分页浏览所有删除记录
- 提供删除统计和分析

#### 2. 快速预览
- 在"用户清理管理"标签页
- 查看最近10条删除记录
- 显示删除总数统计

### 数据表结构
```sql
CREATE TABLE user_deletion_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    emby_user_id TEXT NOT NULL,
    emby_username TEXT NOT NULL,
    linuxdo_user_id INTEGER,
    deletion_reason TEXT NOT NULL,
    registered_at TIMESTAMP,
    last_activity_date TIMESTAMP,
    days_since_registration INTEGER,
    days_since_last_activity INTEGER,
    deleted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_by TEXT DEFAULT 'system'
);
```

## 技术实现

- **调度器**: 使用 APScheduler 实现定时任务
- **用户活跃检查**: 通过 Emby API 获取用户最后活跃时间
- **数据清理**: 同步删除 Emby 用户和数据库记录
- **删除记录**: 自动记录删除详情，支持审计分析
- **错误处理**: 完善的异常处理和日志记录

## 更新日志

- **v1.3.0**: 新增孤儿记录清理功能
  - ✅ **孤儿记录检测**: 自动检测数据库中存在但Emby中不存在的用户记录
  - ✅ **数据一致性维护**: 处理手动删除、同步问题等导致的数据不一致
  - ✅ **自动清理**: 在定时任务中自动执行孤儿记录清理
  - ✅ **手动清理**: 支持管理员手动触发孤儿记录清理
  - ✅ **详细日志**: 记录孤儿记录清理的详细信息
  - ✅ **配置控制**: `CLEANUP_ORPHANED_RECORDS` 环境变量控制

- **v1.2.0**: 新增安全限制功能
  - ✅ **平台用户验证**: 只删除通过平台注册的用户
  - ✅ **多重安全检查**: 数据库记录验证 + 用户信息匹配 + 策略检查
  - ✅ **保护管理员用户**: 管理员手动创建的用户不会被删除
  - ✅ **详细安全日志**: 记录所有验证过程和跳过原因
  - ✅ **配置开关**: `CLEANUP_ONLY_PLATFORM_USERS` 控制安全验证

- **v1.1.0**: 新增用户删除记录功能
  - ✅ 自动记录所有删除用户的详细信息
  - ✅ 提供删除记录查看界面（支持分页）
  - ✅ 在管理后台显示最近删除记录
  - ✅ 包含删除原因、时间统计等详细信息
  - ✅ 支持删除数据的审计和分析

- **v1.0.0**: 初始版本，支持基本的用户清理功能
  - ✅ 支持定时和手动清理
  - ✅ 提供 Web 管理界面
  - ✅ 完整的配置选项和日志记录
